services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports: ["11434:11434"]
    volumes: ["./ollama:/root/.ollama"]
    restart: unless-stopped

  chroma:
    image: ghcr.io/chroma-core/chroma:latest
    container_name: chroma
    environment:
      IS_PERSISTENT: "TRUE"
    ports: ["8000:8000"]
    volumes: ["./chroma:/chroma"]
    restart: unless-stopped
    
  # Optional studio-quality local TTS (uncomment when ready)
  # opentts:
  #   image: rhasspy/opentts:latest
  #   container_name: opentts
  #   ports: ["5500:5500"]
  #   restart: unless-stopped

   oliver-agent:
    image: python:3.11-slim
    container_name: oliver-agent
    working_dir: /app
    environment:
      OLLAMA_HOST: http://ollama:11434
      CHROMA_HOST: http://chroma:8000
      OPENAI: "${OPENAI}"                 # comes from .env
      OPENAI_MODEL: "${OPENAI_MODEL}"     # comes from .env
      OPENAI_API_KEY: "${OPENAI_API_KEY}" # comes from .env
    command: >
      bash -lc "apt-get update &&
                apt-get install -y curl poppler-utils &&
                pip install -r requirements.txt &&
                uvicorn app:app --host 0.0.0.0 --port 8080"
    volumes:
      - ./agent:/app
      - ./data:/data
    ports: ["8080:8080"]
    depends_on: [ollama, chroma]
    restart: unless-stopped
